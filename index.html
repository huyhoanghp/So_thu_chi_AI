<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sổ Thu Chi — Test (Gemini key nhúng trực tiếp)</title>

  <!-- Tailwind with forms plugin -->
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>

  <!-- Chart.js (kept in case you extend) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- SheetJS for Excel export if needed -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>

  <!-- Firebase compat SDKs (auth & firestore used in this HTML) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .modal-backdrop { background: rgba(0,0,0,0.45); }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- Loading overlay -->
  <div id="loading-overlay" class="fixed inset-0 flex items-center justify-center bg-white/80 z-50 hidden">
    <div class="text-center">
      <div class="loader mb-2">Đang tải…</div>
      <div id="loading-text" class="text-sm text-gray-600"></div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed right-6 bottom-6 p-3 rounded-lg shadow-lg opacity-0 transform translate-y-10 transition-all">
    <div id="toast-message" class="text-white"></div>
  </div>

  <!-- Login screen -->
  <div id="login-screen" class="min-h-screen flex items-center justify-center p-6">
    <div class="bg-white rounded-lg p-8 shadow-md max-w-md w-full text-center">
      <h1 class="text-2xl font-bold mb-2">Sổ Thu Chi — Test</h1>
      <p class="text-sm text-gray-600 mb-6">Đăng nhập bằng Google để tiếp tục.</p>
      <button id="google-signin" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Đăng nhập với Google</button>
      <p class="text-xs text-gray-500 mt-4">Lưu ý: file này nhúng trực tiếp Google Gemini API key cho mục đích test (không an toàn cho production).</p>
    </div>
  </div>

  <!-- Main app -->
  <div id="app-container" class="hidden min-h-screen p-6">
    <header class="flex justify-between items-center mb-6">
      <div>
        <h2 class="text-xl font-semibold">Sổ Thu Chi</h2>
        <p class="text-sm text-gray-600">Quản lý thu - chi & thử nghiệm AI</p>
      </div>
      <div class="flex items-center gap-3">
        <div class="text-right mr-2">
          <div id="user-name" class="font-medium"></div>
        </div>
        <img id="user-photo" class="w-10 h-10 rounded-full bg-gray-200" src="" alt="User" />
        <button id="logout-btn" class="px-3 py-2 bg-gray-200 rounded-md">Đăng xuất</button>
      </div>
    </header>

    <div class="mb-4 flex gap-3">
      <button id="add-transaction-btn" class="px-4 py-2 bg-green-600 text-white rounded-md">Thêm giao dịch</button>
      <button id="open-ai-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md">AI: Tạo từ mô tả</button>
    </div>

    <section>
      <h3 class="font-semibold mb-2">Lịch sử giao dịch</h3>
      <div id="transactions-list" class="space-y-2"></div>
    </section>
  </div>

  <!-- Form Modal -->
  <div id="form-modal" class="fixed inset-0 hidden items-center justify-center z-40">
    <div class="modal-backdrop absolute inset-0"></div>
    <form id="main-form" class="relative bg-white rounded-lg p-6 shadow-lg w-full max-w-lg z-10" onsubmit="return false;">
      <h4 id="modal-title" class="text-lg font-semibold mb-4">Thêm Giao Dịch</h4>

      <div class="grid grid-cols-1 gap-3">
        <label class="text-sm">Loại</label>
        <div class="flex gap-4 items-center">
          <label><input type="radio" name="type" value="income" checked> Thu</label>
          <label><input type="radio" name="type" value="expense"> Chi</label>
        </div>

        <label class="text-sm">Mô tả</label>
        <input id="description" class="form-input w-full p-2 rounded border" />

        <label class="text-sm">Số tiền</label>
        <input id="amount" type="number" class="form-input w-full p-2 rounded border" />

        <label class="text-sm">Ngày (YYYY-MM-DD)</label>
        <input id="date" type="date" class="form-input w-full p-2 rounded border" />

        <label class="text-sm">Danh mục</label>
        <select id="category" class="form-select w-full p-2 rounded border"></select>

        <label class="text-sm">Khách hàng (tùy chọn)</label>
        <input id="customerName" class="form-input w-full p-2 rounded border" />

        <label class="text-sm">Ghi chú</label>
        <textarea id="customerNote" class="form-textarea w-full p-2 rounded border"></textarea>

        <div class="flex justify-end gap-3 mt-3">
          <button type="button" class="cancel-btn px-4 py-2 bg-gray-200 rounded" onclick="closeFormModal()">Huỷ</button>
          <button id="save-btn" type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Lưu</button>
        </div>
      </div>
    </form>
  </div>

  <!-- AI Entry Modal -->
  <div id="ai-entry-modal" class="fixed inset-0 hidden items-center justify-center z-40">
    <div class="modal-backdrop absolute inset-0"></div>
    <form id="ai-entry-form" class="relative bg-white rounded-lg p-6 shadow-lg w-full max-w-lg z-10">
      <h4 class="text-lg font-semibold mb-3">Mô tả (Tiếng Việt)</h4>
      <textarea id="ai-input" class="w-full p-2 rounded border" rows="6" placeholder="Ví dụ: Bán 20 ổ bánh mì cho chợ, thu 1,000,000 VND"></textarea>
      <div class="flex justify-end gap-3 mt-3">
        <button type="button" class="cancel-btn px-4 py-2 bg-gray-200 rounded" onclick="closeAiModal()">Huỷ</button>
        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded">Gửi cho AI</button>
      </div>
    </form>
  </div>

<script>
/* ===========================
   Configurations / State
   =========================== */
const GEMINI_API_KEY = "AIzaSyCb6WTOOMERzf_tu7SahPAhU21y6AyFMCc"; // <-- YOUR Gemini API key (embedded for quick test)
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBkgzeseW1hFbiEiHrK6kXtMgdFE4gdUSI",    // Firebase apiKey from Firebase Console
  authDomain: "sothuchiapp-5efc7.firebaseapp.com",
  projectId: "sothuchiapp-5efc7",
  storageBucket: "sothuchiapp-5efc7.firebasestorage.app",
  messagingSenderId: "537279498834",
  appId: "1:537279498834:web:b5277e19fc234d11e36d8b",
  measurementId: "G-XYK5Q974RP"
};

/* DOM elements */
const loginScreen = document.getElementById('login-screen');
const googleSignInBtn = document.getElementById('google-signin');
const appContainer = document.getElementById('app-container');
const userNameEl = document.getElementById('user-name');
const userPhotoEl = document.getElementById('user-photo');
const logoutBtn = document.getElementById('logout-btn');
const loadingOverlay = document.getElementById('loading-overlay');
const toast = document.getElementById('toast');
const toastMessage = document.getElementById('toast-message');

const addTransactionBtn = document.getElementById('add-transaction-btn');
const openAiBtn = document.getElementById('open-ai-btn');
const transactionsList = document.getElementById('transactions-list');

const formModal = document.getElementById('form-modal');
const mainForm = document.getElementById('main-form');
const modalTitle = document.getElementById('modal-title');
const descriptionInput = document.getElementById('description');
const amountInput = document.getElementById('amount');
const dateInput = document.getElementById('date');
const categorySelect = document.getElementById('category');
const customerNameInput = document.getElementById('customerName');
const customerNoteInput = document.getElementById('customerNote');
const saveBtn = document.getElementById('save-btn');

const aiEntryModal = document.getElementById('ai-entry-modal');
const aiEntryForm = document.getElementById('ai-entry-form');
const aiInput = document.getElementById('ai-input');

let auth, db;
let transactionsCollection = null, plansCollection = null;
let transactions = [], plans = [];
let currentUserId = null;
let toastTimeout;
let currentFormMode = null;
let unsubTx = null, unsubPlans = null;
let firstLoads = { tx: false, plans: false };

/* Categories default */
const categories = {
  income: ['Bán tại quán', 'Giao hàng', 'Thu khác'],
  expense: ['Nguyên liệu chính', 'Nguyên liệu phụ', 'Vật tư', 'Chi phí vận hành', 'Chi phí khác']
};

/* ===========================
   Helpers & UI
   =========================== */
function showToast(message, type = "success") {
  clearTimeout(toastTimeout);
  toastMessage.textContent = message;
  toast.classList.remove("bg-green-500", "bg-red-500");
  toast.classList.add(type === "success" ? "bg-green-500" : "bg-red-500");
  toast.classList.remove("opacity-0","translate-y-10");
  toast.style.opacity = "1";
  toast.style.transform = "translateY(0)";
  toastTimeout = setTimeout(() => {
    toast.style.opacity = "";
    toast.style.transform = "";
    toast.classList.add("opacity-0","translate-y-10");
  }, 3500);
}

function parseLocalDate(yyyy_mm_dd) {
  if (!yyyy_mm_dd) return null;
  const parts = yyyy_mm_dd.split('-').map(n => parseInt(n,10));
  if (parts.length < 3) return null;
  const [y,m,d] = parts;
  return new Date(y, (m||1)-1, d||1);
}

function formatDateDisplay(yyyy_mm_dd) {
  const d = parseLocalDate(yyyy_mm_dd);
  if (!d) return '—';
  return d.toLocaleDateString('vi-VN');
}

function updateCategoryOptions() {
  const type = formModal.querySelector('input[name="type"]:checked')?.value || 'income';
  categorySelect.innerHTML = '';
  (categories[type] || []).forEach(cat => {
    const opt = document.createElement('option'); opt.value = cat; opt.textContent = cat;
    categorySelect.appendChild(opt);
  });
}

/* ===========================
   Firebase init & Auth
   =========================== */
try {
  if (typeof firebase === 'undefined') throw new Error("Firebase SDK not loaded.");
  firebase.initializeApp(FIREBASE_CONFIG);
  auth = firebase.auth();
  db = firebase.firestore();
} catch (err) {
  console.error("Firebase init error:", err);
  document.body.innerHTML = `<div class="p-6 text-red-600">Firebase khởi tạo thất bại: ${err.message}</div>`;
}

/* Sign in/out */
googleSignInBtn.addEventListener('click', () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).catch(error => {
    showToast("Đăng nhập thất bại: " + error.message, "error");
  });
});

logoutBtn.addEventListener('click', () => {
  auth.signOut();
});

/* Auth state change — handle unsubscribe and UI */
auth.onAuthStateChanged(user => {
  // cleanup previous listeners
  if (typeof unsubTx === 'function') { try { unsubTx(); } catch(e){}; unsubTx = null; }
  if (typeof unsubPlans === 'function') { try { unsubPlans(); } catch(e){}; unsubPlans = null; }
  firstLoads = { tx: false, plans: false };

  if (user) {
    currentUserId = user.uid;
    userNameEl.textContent = user.displayName || user.email || 'Tài khoản';
    userPhotoEl.src = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || user.email || 'User')}`;

    const transactionsPath = `/artifacts/${FIREBASE_CONFIG.projectId}/users/${currentUserId}/transactions`;
    const plansPath = `/artifacts/${FIREBASE_CONFIG.projectId}/users/${currentUserId}/plans`;
    transactionsCollection = db.collection(transactionsPath);
    plansCollection = db.collection(plansPath);

    loginScreen.classList.add('hidden');
    appContainer.classList.remove('hidden');
    loadingOverlay.classList.remove('hidden');
    listenForData();
  } else {
    currentUserId = null;
    transactions = []; plans = [];
    renderTransactions();
    appContainer.classList.add('hidden');
    loginScreen.classList.remove('hidden');
  }
});

/* ===========================
   Firestore listeners
   =========================== */
function listenForData() {
  if (!transactionsCollection || !plansCollection) return;

  // unsubscribe if already present (defensive)
  if (typeof unsubTx === 'function') { try { unsubTx(); } catch(e){}; unsubTx = null; }
  if (typeof unsubPlans === 'function') { try { unsubPlans(); } catch(e){}; unsubPlans = null; }

  unsubTx = transactionsCollection.onSnapshot(snapshot => {
    let data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    data.sort((a,b) => new Date((b.createdAt || b.date) || 0) - new Date((a.createdAt || a.date) || 0));
    transactions = data;
    firstLoads.tx = true;
    renderTransactions();
    if (firstLoads.tx && firstLoads.plans) loadingOverlay.classList.add('hidden');
  }, err => {
    console.error(err);
    showToast("Không thể tải giao dịch: " + err.message, "error");
    loadingOverlay.classList.add('hidden');
  });

  unsubPlans = plansCollection.onSnapshot(snapshot => {
    let data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    data.sort((a,b) => new Date((b.createdAt || b.date) || 0) - new Date((a.createdAt || a.date) || 0));
    plans = data;
    firstLoads.plans = true;
    if (firstLoads.tx && firstLoads.plans) loadingOverlay.classList.add('hidden');
  }, err => {
    console.error(err);
    showToast("Không thể tải kế hoạch: " + err.message, "error");
    loadingOverlay.classList.add('hidden');
  });
}

/* Simple render for transactions */
function renderTransactions() {
  transactionsList.innerHTML = '';
  if (!transactions || transactions.length === 0) { transactionsList.innerHTML = '<div class="text-sm text-gray-500">Chưa có giao dịch</div>'; return; }
  transactions.forEach(t => {
    const el = document.createElement('div');
    el.className = 'bg-white p-3 rounded shadow-sm flex justify-between items-start';
    el.innerHTML = `<div>
        <div class="font-medium">${t.description || '—'}</div>
        <div class="text-xs text-gray-500">${t.category || ''} • ${t.customerName || ''}</div>
        <div class="text-xs text-gray-400">${formatDateDisplay(t.date)}</div>
      </div>
      <div class="text-right">
        <div class="${(t.type==='expense') ? 'text-red-600' : 'text-green-600'} font-semibold">${t.amount || 0}</div>
      </div>`;
    transactionsList.appendChild(el);
  });
}

/* ===========================
   Form Modal functions
   =========================== */
function openFormModal(mode, data = {}) {
  currentFormMode = mode;
  mainForm.reset();
  dateInput.value = data.date || new Date().toISOString().slice(0,10);
  descriptionInput.value = data.description || '';
  amountInput.value = data.amount != null ? data.amount : '';
  customerNameInput.value = data.customerName || '';
  customerNoteInput.value = data.customerNote || '';

  const typeVal = data.type || 'income';
  const typeInput = formModal.querySelector(`input[name="type"][value="${typeVal}"]`);
  if (typeInput) typeInput.checked = true;

  updateCategoryOptions();
  if (data.category) categorySelect.value = data.category;

  modalTitle.textContent = mode === 'edit' ? 'Chỉnh sửa giao dịch' : (mode === 'addPlan' ? 'Thêm kế hoạch' : 'Thêm giao dịch');
  formModal.classList.remove('hidden');
}

function closeFormModal() {
  formModal.classList.add('hidden');
}

mainForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!transactionsCollection) return showToast('Chưa kết nối Firestore', 'error');
  const doc = {
    description: descriptionInput.value.trim(),
    amount: Number(amountInput.value) || 0,
    date: dateInput.value,
    category: categorySelect.value,
    customerName: customerNameInput.value.trim(),
    customerNote: customerNoteInput.value.trim(),
    type: formModal.querySelector('input[name="type"]:checked')?.value || 'income',
    createdAt: new Date().toISOString()
  };
  try {
    await transactionsCollection.add(doc);
    showToast('Lưu giao dịch thành công', 'success');
    closeFormModal();
  } catch (err) {
    console.error(err);
    showToast('Lưu thất bại: ' + err.message, 'error');
  }
});

/* ===========================
   AI Entry handling (direct Gemini call)
   =========================== */
openAiBtn.addEventListener('click', () => {
  aiEntryModal.classList.remove('hidden');
});

function closeAiModal() { aiEntryModal.classList.add('hidden'); }

aiEntryForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const text = aiInput.value.trim();
  if (!text) return showToast('Vui lòng nhập mô tả', 'error');
  aiEntryForm.querySelector('button[type="submit"]').disabled = true;
  loadingOverlay.classList.remove('hidden');

  const prompt = `Hãy phân tích đoạn mô tả bằng tiếng Việt và trả về một JSON duy nhất (không giải thích) có các trường:
{
 "type": "income" hoặc "expense",
 "description": "mô tả ngắn",
 "amount": số (chỉ số, không có ký tự),
 "category": "một trong các danh mục",
 "date": "YYYY-MM-DD",
 "customerName": "tên khách (nếu có)",
 "customerNote": "ghi chú (nếu có)"
}
Văn bản nguồn: "${text}"
Nếu không chắc amount hoặc date, để rỗng ("") cho trường đó.`;

  try {
    const apiKey = GEMINI_API_KEY;
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

    // Payload: we put the prompt as plain text inside contents.parts.text (this mirrors how some client examples use)
    const payload = {
      temperature: 0.2,
      candidateCount: 1,
      maxOutputTokens: 800,
      // Using the 'contents' format: parts with text containing the prompt.
      contents: [{ parts: [{ text: prompt }] }]
    };

    const resp = await fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!resp.ok) {
      const txt = await resp.text();
      throw new Error(`AI API lỗi: ${resp.status} ${txt}`);
    }

    const result = await resp.json();
    // Try common places where model text may appear:
    let rawText = null;
    // Newer format:
    if (result?.candidates?.[0]?.content?.[0]?.text) rawText = result.candidates[0].content[0].text;
    // Older-ish nested parts:
    if (!rawText && result?.candidates?.[0]?.content?.parts?.[0]?.text) rawText = result.candidates[0].content.parts[0].text;
    // As fallback try top-level
    if (!rawText && typeof result === 'string') rawText = result;
    if (!rawText) {
      // attempt to find any text in the JSON
      const allText = JSON.stringify(result);
      const m = allText.match(/\{[\s\S]*\}/);
      if (m) rawText = m[0];
    }

    if (!rawText) throw new Error('Không nhận được phản hồi dạng văn bản từ AI.');

    // Extract JSON substring if the model returned explanation + JSON
    const jsonMatch = rawText.match(/\{[\s\S]*\}/);
    const jsonText = jsonMatch ? jsonMatch[0] : rawText;

    let parsed = {};
    try {
      parsed = JSON.parse(jsonText);
    } catch (err) {
      // If parse fails, try to clean common mistakes (single quotes -> double)
      try {
        const cleaned = jsonText.replace(/(['"])?([a-zA-Z0-9_]+)\1\s*:/g, '"$2":').replace(/'/g, '"');
        parsed = JSON.parse(cleaned);
      } catch (err2) {
        throw new Error('AI trả về JSON không hợp lệ: ' + err2.message);
      }
    }

    // Open form modal with parsed data
    openFormModal('addTransaction', parsed);
    showToast('AI đã phân tích — kiểm tra form và lưu nếu đúng', 'success');
    closeAiModal();
  } catch (err) {
    console.error('AI error:', err);
    showToast('Lỗi AI: ' + err.message, 'error');
  } finally {
    aiEntryForm.querySelector('button[type="submit"]').disabled = false;
    loadingOverlay.classList.add('hidden');
  }
});

/* ===========================
   UI wiring
   =========================== */
addTransactionBtn.addEventListener('click', () => openFormModal('addTransaction', {}));
document.querySelectorAll('.cancel-btn').forEach(btn => btn.addEventListener('click', () => {
  closeFormModal();
  closeAiModal();
}));

// Radio change -> update categories
formModal.querySelectorAll('input[name="type"]').forEach(r => r.addEventListener('change', updateCategoryOptions));

/* Quick note: to test this file properly, run it via a local HTTP server:
   python -m http.server 8000
   then open http://localhost:8000/QLTC_10_AI_final.html
   Do NOT open via file:/// because Firebase Auth popup requires HTTP/HTTPS origin to be authorized.
*/

</script>

</body>
</html>
